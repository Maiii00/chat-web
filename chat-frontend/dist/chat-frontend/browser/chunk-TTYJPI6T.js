import{a as z}from"./chunk-OSUW3NIR.js";import{a as R,b as $,e as A,h as F}from"./chunk-QVCSQME4.js";import{a as U,b as D}from"./chunk-J7CTMRYQ.js";import{$ as _,A as m,Ba as V,Ha as h,I as l,M as b,Q as v,T as f,V as a,W as c,Y as C,Z as u,_ as w,aa as x,ba as y,ca as p,da as M,fa as O,ga as I,ha as P,ja as S,ra as k,sa as E,ua as T,w as r,ya as B,z as d}from"./chunk-277JHPB5.js";var j=["chatMessages"],K=o=>({"own-message":o});function Q(o,s){if(o&1&&(a(0,"div",8)(1,"div",9)(2,"span",10),p(3),c()()()),o&2){let e=s.$implicit,t=w();f("ngClass",S(2,K,e.senderId===t.senderId)),l(3),M(e.content)}}var N=class o{id;receiverId;receiverUsername="";messages=[];newMessage="";chatState=r(D);route=r(V);wsService=r(z);http=r(B);auth=r(U);messageSub=null;senderId=this.auth.getUserId();chatMessagesRef;ngOnInit(){this.route.paramMap.subscribe(s=>{this.receiverId=s.get("userId")||"",this.http.get(`${h.apiBaseUrl}/users/${this.receiverId}`).subscribe(e=>{this.receiverUsername=e.username}),this.messages=this.chatState.getMessages(this.receiverId),this.wsService.getMessages().subscribe(e=>{if(!e)return;let t=e.senderId===this.receiverId||e.receiverId===this.receiverId,n=this.messages.some(i=>i.id===e.id);t&&!n&&(this.messages.push(e),this.chatState.setMessages(this.receiverId,[...this.messages]),this.scrollToBottom())}),this.http.get(`${h.apiBaseUrl}/messages/history?user1=${this.senderId}&user2=${this.receiverId}`).subscribe(e=>{let t=new Set(this.messages.map(i=>i.id)),n=e.filter(i=>!t.has(i.id));this.messages=[...n.reverse(),...this.messages],this.chatState.setMessages(this.receiverId,[...this.messages]),this.scrollToBottom()})})}scrollToBottom(){requestAnimationFrame(()=>{if(this.chatMessagesRef){let s=this.chatMessagesRef.nativeElement;s.scrollTop=s.scrollHeight}})}sendMessage(){if(this.newMessage.trim()){let s={id:this.id,receiverId:this.receiverId,content:this.newMessage},e={Authorization:`Bearer ${this.auth.getToken()}`};console.log(`Bearer ${this.auth.getToken()}`),console.log(localStorage.getItem("refreshToken")),this.http.post(`${h.apiBaseUrl}/messages`,s,{headers:e}).subscribe({next:()=>{this.newMessage="",this.chatState.setMessages(this.receiverId,[...this.messages]),this.chatState.notifyConversationUpdate(),this.scrollToBottom()},error:t=>console.error("sendMessage error",t)})}}currentPage=0;loadMore(){this.currentPage+=1,this.http.get(`${h.apiBaseUrl}/messages/history?user1=${this.senderId}&user2=${this.receiverId}&page=${this.currentPage}&size=20`).subscribe(s=>{let e=new Set(this.messages.map(n=>n.id)),t=s.filter(n=>!e.has(n.id));this.messages=[...t.reverse(),...this.messages],this.chatState.setMessages(this.receiverId,this.messages)})}handleKeyDown(s){s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),this.sendMessage())}handleScroll(){this.chatMessagesRef.nativeElement.scrollTop===0&&this.loadMore()}ngAfterViewInit(){this.scrollToBottom(),this.chatMessagesRef.nativeElement.addEventListener("scroll",this.handleScroll.bind(this))}ngOnDestroy(){this.messageSub?.unsubscribe(),this.chatMessagesRef?.nativeElement.removeEventListener("scroll",this.handleScroll.bind(this))}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=b({type:o,selectors:[["app-chat"]],viewQuery:function(e,t){if(e&1&&_(j,5),e&2){let n;x(n=y())&&(t.chatMessagesRef=n.first)}},decls:11,vars:3,consts:[["chatMessages",""],[1,"chat-container"],[1,"chat-header"],[1,"chat-messages"],["class","chat-message",3,"ngClass",4,"ngFor","ngForOf"],[1,"chat-input"],["rows","2","placeholder","\u8F38\u5165\u8A0A\u606F...",3,"ngModelChange","keydown","ngModel"],[3,"click"],[1,"chat-message",3,"ngClass"],[1,"message-bubble"],[1,"content"]],template:function(e,t){if(e&1){let n=C();a(0,"div",1)(1,"header",2)(2,"h2"),p(3),c()(),a(4,"section",3,0),v(6,Q,4,4,"div",4),c(),a(7,"footer",5)(8,"textarea",6),P("ngModelChange",function(g){return d(n),I(t.newMessage,g)||(t.newMessage=g),m(g)}),u("keydown",function(g){return d(n),m(t.handleKeyDown(g))}),c(),a(9,"button",7),u("click",function(){return d(n),m(t.sendMessage())}),p(10,"\u767C\u9001"),c()()()}e&2&&(l(3),M(t.receiverUsername),l(3),f("ngForOf",t.messages),l(2),O("ngModel",t.newMessage))},dependencies:[T,k,E,F,R,$,A],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100vh;border-left:1px solid #ddd;box-shadow:none;background:#fff;max-width:none;border-radius:12px;overflow:hidden}.chat-header[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff;padding:1.5rem;font-size:1.2rem;border-bottom:1px solid #e0e0e0;margin:0;display:flex;justify-content:center;align-items:center}.chat-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1rem;text-align:center}.chat-messages[_ngcontent-%COMP%]{flex:1;padding:1rem;overflow-y:auto;background-color:#fafafa;display:flex;flex-direction:column;gap:10px;scrollbar-width:none;scroll-behavior:smooth}.chat-message[_ngcontent-%COMP%]{display:flex}.chat-message.own-message[_ngcontent-%COMP%]{justify-content:flex-end}.chat-message.own-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:#dcf8c6;align-items:flex-end}.chat-message[_ngcontent-%COMP%]:not(.own-message){justify-content:flex-start}.chat-message[_ngcontent-%COMP%]:not(.own-message)   .message-bubble[_ngcontent-%COMP%]{background-color:#fff;align-items:flex-start}.chat-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{padding:10px 14px;border-radius:12px;max-width:60%;box-shadow:0 2px 4px #0000000d}.chat-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]:hover{box-shadow:0 4px 8px #00000026}.chat-message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{word-wrap:break-word}.chat-input[_ngcontent-%COMP%]{display:flex;padding:.5rem;border-top:1px solid #ccc;background-color:#f9f9f9}.chat-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{flex:1;padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:20px;resize:none;height:45px;line-height:1.4;outline:none}.chat-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{border-color:#4caf50}.chat-input[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-left:10px;padding:8px 20px;font-size:1rem;background-color:#4caf50;color:#fff;border:none;border-radius:20px;cursor:pointer}.chat-input[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#45a049}"]})};export{N as ChatComponent};
